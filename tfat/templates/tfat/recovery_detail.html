{% extends "tfat/tfat_base.html" %}

{% load static %}
{% load leaflet_tags %}
{% load tfat_tags %}
{% load humanize %}

{% block extrahead %}

  {% leaflet_js %}
  {% leaflet_css %}

  <script src="/static/Leaflet.MakiMarkers.js"></script>


<style>

    #mymap {  /* all maps */
        width:  700px;
        height: 600px;
    }

    td {
        padding: 0px 10px 2px 0px;}

     /*make leaflet popups wrap text*/
     .leaflet-popup-content{
         /*width: 100px;*/
         white-space: normal;
     }




</style>


{% endblock %}


{% block content %}
<div class="container">

    <div class="row">
        <h2>Tag Recovery Event ({{ recovery.id }})</h2>
        <div class="btn-toolbar pull-right">
            <a class="btn btn-primary" href="{% url 'tfat:edit_recovery' recovery_id=recovery.id  %}" role="button">
            <span class="glyphicon glyphicon-edit"></span>Edit Recovery Details</a>
        {% if add_another %}
            <a class="btn btn-danger" href="{% url 'tfat:create_recovery' report_id=recovery.report.id  %}" role="button">
                <span class="glyphicon glyphicon-plus-sign"></span>  Add Another Tag </a>
        {% endif %}
        </div>
    </div>

    <hr />

    <div class="row">
        <div class="col-md-4" >
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Recovery Details
                    <a class="btn btn-default btn-xs pull-right"
                       href="{% url 'tfat:report_detail' report_id=recovery.report.id %}"
                       role="button">Report Details</a>
                    </h3>
                </div>
                <div class="panel-body">
                    <table>

                        <tr>
                            <td><em>Reported By:</em></td>
                            {% url 'tfat:angler_reports' recovery.report.reported_by.id as the_url %}
                            <td><a href="{{ the_url }}">{{ recovery.report.reported_by }}</a> </td>
                        </tr>


                        <tr>
                            <td><em>Report Date:</em></td>
                            <td>{{ recovery.report.report_date|date:"M d, Y" }}
                        </tr>


                        <tr>
                            <td><em>Recapture Date:</em></td>
                            <td>{{ recovery.recovery_date|date:"M d, Y" }} ({{ recovery.get_date_flag_display }})</td>
                        </tr>
                        <tr>
                            <td><em>Species:</em></td>
                            <td>{{ recovery.spc }}</td>
                        </tr>
                    </table>

                </div>
            </div>



            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Tag Attributes</h3>
                </div>
                <div class="panel-body">
                    <table>

                        <tr>
                            <td><em>Tag ID:</em></td>
                            {% url 'tfat:tagid_detail_view' tagid=recovery.tagid as the_url %}
                            <td><a href="{{ the_url }}">{{ recovery.tagid }}</a> </td>
                        </tr>

                        <tr>
                            <td><em>TAGDOC:</em></td>
                            <td>{{ recovery.tagdoc }}</td>
                        </tr>
                    </table>

                    <br />
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <table>
                                    <tr>
                                        <td><em>Colour:</em></td>
                                        <td>{{ recovery.tag_colour }}</td>
                                    </tr>

                                    <tr>
                                        <td><em>Type:</em></td>
                                        <td>{{ recovery.tag_type }}</td>
                                    </tr>

                                    <tr>
                                        <td><em>Placement:</em></td>
                                        <td>{{ recovery.tag_position }}</td>
                                    </tr>

                                    <tr>
                                        <td><em>Agency:</em></td>
                                        <td>{{ recovery.tag_origin }}</td>
                                    </tr>

                                </table>
                            </div>
                        </div>



                </div>
            </div>



            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Recapture Location </h3>
                </div>
                <div class="panel-body">
                    <table>

                        <tr>
                            <td><em>General Location:</em></td>
                            <td>{{ recovery.general_location }}</td>
                        </tr>

                        <tr>
                            <td><em>Specific Location:</em></td>
                            <td>{{ recovery.specific_location }}</td>
                        </tr>


                        <tr>
                            <td><em>Coordinates:</em></td>
                            <td>{{ recovery.get_latlon_flag_display }}</td>
                        </tr>

                        {% if recovery.has_latlon %}
                        <tr>
                            <td><em>Latitude:</em></td>
                            <td>{{ recovery.dd_lat|ddm }}</td>
                        </tr>

                        <tr>
                            <td><em>Longitude:</em></td>
                            <td>{{ recovery.dd_lon|ddm }}</td>
                        </tr>
                        {% endif %}

                    </table>

                </div>
            </div>


        </div>

        <div class="col-md-8" >

            {% if recovery.has_latlon %}
            <script type="text/javascript">

             function map_init_basic (map, options) {
                 map.setZoom(7)
                     {% if recovery.dd_lat and recovery.dd_lon %}
                     L.marker([{{ recovery.dd_lat }}, {{ recovery.dd_lon}}]).addTo(map).bindPopup('{{ recovery.popup_text|safe }}');
                 {% endif %}
             }

            </script>
            {% endif %}

            {% leaflet_map "mymap" callback="window.map_init_basic" %}
            <br>
        </div>
    </div>


    <div class="row" >
        <div  class="col-md-4" >

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Fish Attributes </h3>
                </div>
                <div class="panel-body">
                    <table>

                        <tr>
                            <td><em>Fate:</em></td>
                            <td>{{ recovery.get_fate_display }}</td>
                        </tr>

                        <tr>
                            <td><em>Tag Removed:</em></td>
                            <td>{{ recovery.tag_removed }}</td>
                        </tr>

                        {% if recovery.flen %}

                        <tr>
                            <td><em>Fork Length:</em></td>
                            <td>{{ recovery.flen }} mm ( {{ recovery.flen_inches }} inches)</td>
                        </tr>

                        {% endif%}


                        {% if recovery.tlen %}

                        <tr>
                            <td><em>Total Length:</em></td>
                            <td>{{ recovery.tlen }} mm ( {{ recovery.tlen_inches }} inches)</td>
                        </tr>

                        {% endif %}

                        {% if recovery.rwt %}

                        <tr>
                            <td><em>Weight:</em></td>
                            <td>{{ recovery.rwt|intcomma }} g ( {{ recovery.pounds }} lbs)</td>
                        </tr>

                        {% endif %}


                        {% if recovery.girth %}

                        <tr>
                            <td><em>Girth:</em></td>
                            <td>{{ recovery.girth }} mm ( {{ recovery.girth_inches }} inches)</td>
                        </tr>

                        {% endif %}




                        <tr>
                            <td><em>Clip:</em></td>
                            <td>{{ recovery.clipc }}</td>
                        </tr>


                        <tr>
                            <td><em>Sex:</em></td>
                            <td>{{ recovery.get_sex_display }}</td>
                        </tr>

                    </table>
                </div>
            </div>
        </div>


        <div  class="col-md-4" >

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Additional Comments</h3>
                </div>
                <div class="panel-body">
                    <p style="white-space:pre">{{ recovery.comment|linebreaks }}</p>
                </div>
            </div>
        </div>

    </div>



    {% if recovery.recovery_letters.all %}


    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Recovery Letters</h3>
        </div>
        <div class="panel-body">

            <table class="table">
                <thead>
                <tr>
                    <td>File Name</td>
                    <td>Map Zoom</td>
                    <td>Creation Method</td>
                </tr>
                </thead>
                <tbody>
                    {% for letter in recovery.recovery_letters.all %}
                    <tr>
                        <td> <a href="{% url 'tfat:serve_file' letter.letter %}">{{ letter.letter }}</a> </td>
                        <td>{{ letter.zoom  | default:"---" }}</td>
                        <td>{{ letter.get_method_display | default:"---" }}</td>

                        <td><button type="button" class="btn btn-danger btn-xs">
                            <span class="glyphicon glyphicon-retweet" aria-hidden="true"></span> Repace Letter
                        </button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </div>

    {% endif %}

    {% if recovery.dd_lat and recovery.dd_lon and recovery.tag_applied %}
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#reportModal">
        <span class="glyphicon glyphicon-edit"></span>Create New Recovery Letter
    </button>

    {% endif %}






    <hr />

</div>


<!-- Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">Create Recovery Letter</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <form id="zoomForm">
                        <div class="form-group">
                            <label for="map-zoom" class="col-form-label">Map Zoom:</label>
                            <select class="form-control" id="map-zoom">
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                                <option>6</option>
                                <option>7</option>
                                <option>8</option>
                                <option>9</option>
                                <option selected>10</option>
                                <option>11</option>
                                <option>12</option>
                                <option>13</option>
                                <option>14</option>
                                <option>15</option>
                                <option>16</option>
                                <option>17</option>
                                <option>18</option>
                                <option>19</option>
                                <option>20</option>
                            </select>
                        </div>
                    </form>

                    <p>Note: larger numbers zoom in closer.</p>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary zoom-form-submit">Create Letter</button>
                </div>
            </div>
        </div>
    </div>


<div class="modal fade" tabindex="-1" role="dialog" id="processingModal">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Processing....</h4>
      </div>
      <div class="modal-body">
          <img src={% static 'ajax-loader.gif'  %} class="" alt="" height="80px" width="80px"/>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<script type="text/javascript">





 // this opens our modal dialog box:
 $('#reportModal').on('shown.bs.modal', function () {
     $('#zoom-form-submit').trigger('focus')
 })


$('#reportModal').on('hidden', function () {
  // Load up a new modal...

})

     // create the report using the value in our drop-down box:
     $(function () {
         $('body').on('click', '.zoom-form-submit', function (e) {
             $('#reportModal').modal('hide');
             $('#processingModal').modal('show');
             var url = "{% url 'tfat:make_recovery_letter' recovery_id=recovery.id zoom=99 %}";
             var zoom = $('#map-zoom').val();
             url = url.substring(0, url.length - 3) + zoom + "/";
             document.location.href = url;
         });

     });




</script>


{% endblock content%}
