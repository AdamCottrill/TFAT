{% extends "tfat\tfat_base.html" %}

{% block extrahead %}

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />

<style type="text/css" media="screen">

.modal .modal-dialog { width: 950px; }

</style>

{% endblock extrahead %}


{% block content %}
<div class="container">
    <h2>Tag Recovery Event</h2>
    <div class="panel panel-default">
        <div class="panel-body">

            <form method="post" action=".">
                {% csrf_token %}
                {% if form.errors %}
                <div class="alert alert-danger">
                    Please fix the errors in the form below.
                    {% for error in form.non_field_errors %}
                    <p class="error">{{ error }}</p>
                    {% endfor %}
                    {% for error in form.errors %}
                    <p class="error">{{ error }}</p>
                    {% endfor %}


                </div>
                {% endif %}

                {% if msg %}
                <div class="alert alert-danger">
                    {{ msg }}
                </div>
                {% endif %}

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Tag Recovery Details</h3>
                    </div>
                    <div class="panel-body">

                        <div id="tagid_row" class="row" >
                            <div class="col-md-3" >
                                <div class="form-group {% if form.tagid.errors %}has-error{% endif %}">
                                    {{ form.tagid.label_tag }}
                                    {{ form.tagid }}
                                    {% if form.tagid.errors %}
                                    {% for error in form.tagid.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3" >
                                <div class="form-group {% if form.spc.errors %}has-error{% endif %}">
                                    {{ form.spc.label_tag }}
                                    {{ form.spc }}
                                    {% if form.spc.errors %}
                                    {% for error in form.spc.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3" >
                                <div class="form-group {% if form.recovery_date.errors %}has-error{% endif %}">
                                    {{ form.recovery_date.label_tag }}
                                    {{ form.recovery_date }}
                                    {% if form.recovery_date.errors %}
                                    {% for error in form.recovery_date.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-3" >
                                <div class="form-group {% if form.date_flag.errors %}has-error{% endif %}">
                                    {{ form.date_flag.label_tag }}
                                    {{ form.date_flag }}
                                    {% if form.date_flag.errors %}
                                    {% for error in form.date_flag.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> <!-- tagid row -->
                    </div>
                </div>  <!-- Details Panel -->

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Tag Attributes</h3>
                    </div>
                    <div class="panel-body">

                        <div id="tagdoc_row" class="row" >
                            <div class="col-md-1 text-right" >
                                {{ form.tagdoc.label_tag }}
                            </div>
                            <div class="col-md-2" >
                                <div class="form-group {% if form.tagdoc.errors %}has-error{% endif %}">
                                    {{ form.tagdoc }}
                                    {% if form.tagdoc.errors %}
                                    {% for error in form.tagdoc.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                    <div id="tagdoc_length" class="alert alert-danger" role="alert">
                                        TAGDOC must be exactly 5 characters long.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2" >
                                <a class="btn btn-primary" role="button" data-toggle="collapse" href="#collapseTagdoc" aria-expanded="false" aria-controls="collapseTagdoc"> TAGDOC Helper</a>
                            </div>
                        </div>


                        <div class="collapse" id="collapseTagdoc">
                            <br />
                            <div class="well">
                                <div class="row" >
                                    <div class="col-md-3" >
                                        <div id="tagtype_panel" class="panel panel-default">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">Tag Type</h4>
                                            </div>
                                            <div class="panel-body">

                                                {% for key, val in tag_types %}
                                                <div class="radio">
                                                    <label>
                                                        <input type="radio" name="tagtype_options" id="tagtype_options{{ key }}" value="{{ key }}">
                                                        {{ val }} ({{ key }})
                                                    </label>
                                                </div>
                                                {% endfor %}


                                                <div id="tagtype_error" class="alert alert-danger" role="alert">
                                                    <div id="tagtype_error_text">Invalid Tag Type.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> <!-- col-md-3 -->

                                    <div class="col-md-3" >
                                        <div id="tagposition_panel" class="panel panel-default">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">Tag Position</h4>
                                            </div>
                                            <div class="panel-body">
                                                {% for key, val in tag_position %}
                                                <div class="radio">
                                                    <label>
                                                        <input type="radio" name="tagposition_options" id="tagposition_options{{ key }}" value="{{ key }}">
                                                        {{ val }} ({{ key }})
                                                    </label>
                                                </div>
                                                {% endfor %}

                                                <div id="tagposition_error" class="alert alert-danger" role="alert">
                                                    <div id="tagposition_error_text">Invalid Tag Position.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-3" >
                                        <div id="tagorigin_panel" class="panel panel-default">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">Agency</h4>
                                            </div>
                                            <div class="panel-body">

                                                {% for key, val in tag_origin %}
                                                <div class="radio">
                                                    <label>
                                                        <input type="radio" name="tagorigin_options" id="tagorigin_options{{ key }}" value="{{ key }}" >
                                                        {{ val }} ({{ key }})
                                                    </label>
                                                </div>
                                                {% endfor %}
                                                <div id="tagorigin_error" class="alert alert-danger" role="alert">
                                                    <div id="tagorigin_error_text">Invalid Agency Code.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-3" >
                                        <div id="tagcolour_panel" class="panel panel-default">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">Colour</h4>
                                            </div>
                                            <div class="panel-body">

                                                {% for key, val in tag_colours %}
                                                <div class="radio">
                                                    <label>
                                                        <input type="radio"  name="tagcolour_options" id="tagcolour_options{{ key }}" value="{{ key }}">
                                                        {{ val }} ({{ key }})
                                                    </label>
                                                </div>
                                                {% endfor %}
                                                <div id="tagcolour_error" class="alert alert-danger" role="alert">
                                                    <div id="tagcolour_error_text">Invalid Tag Colour.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div> <!-- row -->
                            </div> <!-- well -->
                        </div> <!-- collapse -->
                    </div>
                </div> <!-- Tag Attributes Panel -->

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Recovery Location</h3>
                    </div>
                    <div class="panel-body">


                        <div id="location_row" class="row" >
                            <div class="col-md-6" >

                                <div class="form-group {% if form.lake.errors %}has-error{% endif %}">
                                    {{ form.lake.label_tag }}
                                    {{ form.lake }}
                                    {% if form.lake.errors %}
                                        {% for error in form.lake.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                

                                <div class="form-group {% if form.general_location.errors %}has-error{% endif %}">
                                    {{ form.general_location.label_tag }}
                                    {{ form.general_location }}
                                    {% if form.general_location.errors %}
                                    {% for error in form.general_location.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="form-group {% if form.specific_location.errors %}has-error{% endif %}">
                                    {{ form.specific_location.label_tag }}
                                    {{ form.specific_location }}
                                    {% if form.specific_location.errors %}
                                    {% for error in form.specific_location.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>

                                <div class="row" >
                                    <div class="col-md-6" >
                                        <h4>Coordinates</h4>
                                    </div>
                                    <div class="col-md-6" >
                                        <div class="form-group {% if form.effort.errors %}has-error{% endif %}">
                                            <div class="checkbox">
                                                <label>
                                                    {{ form.spatial_followup }}
                                                    Spatial Follow-up Required
                                                </label>
                                            </div>
                                            {% if form.follow_up.errors %}
                                            {% for error in form.follow_up.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>

                                </div>

                                <div class="panel panel-default"> <!-- out tabpanel -->
                                    <div class="panel-body">      <!-- out tab panel body-->

                                <div>
                                    <!-- Nav tabs -->
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li role="presentation" class="active"><a href="#decimal_degrees" aria-controls="decimal_degrees" role="tab" data-toggle="tab">Dec. Deg.</a></li>
                                        <li role="presentation"><a href="#ddm" aria-controls="ddm" role="tab" data-toggle="tab">Dec. Minutes</a></li>
                                        <li role="presentation"><a href="#dms" aria-controls="dms" role="tab" data-toggle="tab">Deg-Min-Secs</a></li>
                                        <li role="presentation"><a href="#grid" aria-controls="grid" role="tab" data-toggle="tab">5-Min Grid</a></li>

                                    </ul>

                                    <!-- Tab panes -->
                                    <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="decimal_degrees">

                                            <br />
                                            <p><strong>Latitude:</strong></p>
                                            <div class="form-group">
                                                <label class="sr-only" for="id_dd_lat">Latitude:</label>
                                                <input type="text" class="form-control" id="id_dd_lat" name="dd_lat" type="text" placeholder="Decimal Degrees" value="{{ form.dd_lat.value|default_if_none:''}}">
                                                <div id="dd_lat_deg_error" class="alert alert-danger" role="alert">
                                                    Degrees must be a number between -90 and 90!
                                                </div>
                                                {% if form.dd_lat.errors %}
                                                {% for error in form.dd_lat.errors %}
                                                <div class="has-error help-block text-danger">{{ error }}</div>
                                                {% endfor %}
                                                {% endif %}
                                            </div>

                                            <p><strong>Longitude:</strong></p>
                                            <div class="form-group">
                                                <label class="sr-only" for="id_dd_lon">Longitude:</label>
                                                <input type="text" class="form-control" id="id_dd_lon" name="dd_lon" type="text" placeholder="Decimal Degrees" value="{{ form.dd_lon.value|default_if_none:'' }}">
                                                <div id="dd_lon_deg_error" class="alert alert-danger" role="alert">
                                                    Degrees must be a number between -180 and 180!
                                                </div>
                                                {% if form.dd_lon.errors %}
                                                {% for error in form.dd_lon.errors %}
                                                <div class="has-error help-block text-danger">{{ error }}</div>
                                                {% endfor %}
                                                {% endif %}


                                            </div>


                                        </div> <!-- tabpanel -->
                                        <div role="tabpanel" class="tab-pane" id="ddm">
                                            <br />
                                            <p><strong>Latitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-6" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="ddm_lat_deg">Degrees:</label>
                                                        <input type="text" name="ddm_lat" class="form-control" id="ddm_lat_deg" placeholder="Degrees">
                                        <div id="ddm_lat_deg_error" class="alert alert-danger" role="alert">
                                            Degrees must be an integer!
                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-6" >

                                                    <div class="form-group">
                                                        <label  class="sr-only" for="ddm_lat_min">Decimal Minutes:</label>
                                                        <input type="text" name="ddm_lat" class="form-control" id="ddm_lat_min" placeholder="Decimal Minutes">
                                        <div id="ddm_lat_min_error" class="alert alert-danger" role="alert">
                                            Minutes must be between 0 and 60!
                                        </div>
                                                    </div>

                                                </div>
                                            </div>

                                            <p><strong>Longitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-6" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="ddm_lon_deg">Degrees:</label>
                                                        <input type="text" name="ddm_lon" class="form-control" id="ddm_lon_deg" placeholder="Degrees">
                                        <div id="ddm_lon_deg_error" class="alert alert-danger" role="alert">
                                            Degrees must be an integer!
                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-6" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="ddm_lon_min">Decimal Minutes:</label>
                                                        <input type="text" name="ddm_lon" class="form-control" id="ddm_lon_min" placeholder="Decimal Minutes">
                                        <div id="ddm_lon_min_error" class="alert alert-danger" role="alert">
                                            Minutes must be between 0 and 60!
                                        </div>

                                                    </div>
                                                </div>
                                            </div>


                                        </div>  <!-- tabpanel -->

                                        <div role="tabpanel" class="tab-pane" id="dms">
                                            <br />

                                            <p><strong>Latitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="dms_lat_deg">Degrees:</label>
                                                        <input type="text" name="dms_lat" class="form-control" id="dms_lat_deg" placeholder="Degrees">
                                        <div id="dms_lat_deg_error" class="alert alert-danger" role="alert">
                                            Degrees must be an integer between -90 and 90!
                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lat_min">Minutes:</label>
                                                        <input type="text"  name="dms_lat"  class="form-control" id="dms_lat_min" placeholder="Minutes">
                                        <div id="dms_lat_min_error" class="alert alert-danger" role="alert">
                                            Minutes must be an integer between 0 and 59!
                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lat_sec">Seconds:</label>
                                                        <input type="text"  name="dms_lat" class="form-control" id="dms_lat_sec" placeholder="Seconds">
                                        <div id="dms_lat_sec_error" class="alert alert-danger" role="alert">
                                            seconds must be between 0 and 60!
                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <p><strong>Longitude:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="dms_lon_deg">Degrees:</label>
                                                        <input type="text"  name="dms_lon" class="form-control" id="dms_lon_deg" placeholder="Degrees">
                                        <div id="dms_lon_deg_error" class="alert alert-danger" role="alert">
                                            Degrees must be an integer between -180 and 180!
                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lon_min">Minutes:</label>
                                                        <input type="text" name="dms_lon" class="form-control" id="dms_lon_min" placeholder="Minutes">
                                        <div id="dms_lon_min_error" class="alert alert-danger" role="alert">
                                            Minutes must be an integer between 0 and 59!
                                        </div>

                                                    </div>
                                                </div>
                                                <div class="col-md-4" >
                                                    <div class="form-group">
                                                        <label  class="sr-only" for="dms_lon_sec">Seconds:</label>
                                                        <input type="text" name="dms_lon" class="form-control" id="dms_lon_sec" placeholder="Seconds">
                                        <div id="dms_lon_sec_error" class="alert alert-danger" role="alert">
                                            Seconds must be between 0 and 60!
                                        </div>

                                                    </div>
                                                </div>

                                            </div>


                                        </div>  <!-- tabpanel -->

                                        <div role="tabpanel" class="tab-pane" id="grid">

                                            <br />

                                            <p><strong>5-Minute Grid Number:</strong></p>
                                            <div class="row" >
                                                <div class="col-md-3" >
                                                    <div class="form-group">
                                                        <label class="sr-only" for="grid_no">5-Minute Grid Number:</label>
                                                        <input type="text"  name="grid_no" class="form-control" id="grid_no" placeholder="1942">
                                                    </div>
                                                </div>
                                                <div class="col-md-5" >
                                                    <select class="form-control" id="lake_name">
                                                        <option>Lake Huron</option>
                                                        <option>Lake Superior</option>
                                                        <option>Lake Erie</option>
                                                        <option>Lake Ontario</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div id="grid_no_error" class="alert alert-danger" role="alert">
                                                'Oops! I can't seem to find that grid number!'
                                            </div>


                                        </div>  <!-- tabpanel -->
                                    </div>  <!-- tabcontent -->
                                </div>  <!-- outer tab panel body -->
                                </div> <!-- outer tab panel -->
                            </div>

                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    {{ form.latlon_flag.label_tag }}
                                <button type="button" class="btn btn-default btn-xs pull-right" data-container="body" data-toggle="popover" data-placement="left" data-html="true" data-content=
"<div><p><strong>Unknown:</strong> No spatial data available.</p>
     <p><strong>Reported:</strong> Coordinates or 5-minute grid provided.</p>
     <p><strong>Derived:</strong> Best guess based on broad geographic description (e.g QMA) or auxillary information.</p></div>
">
                                    What is this?
                                </button>
                                </div>
                                <div class="panel-body">
                                    <div class="form-group {% if form.latlon_flag.errors %}has-error{% endif %}">

                                        {% for radio in form.latlon_flag %}
                                        <label class="radio-inline">
                                            {{ radio }}
                                        </label>
                                        {% endfor %}
                                        {% if form.latlon_flag.errors %}
                                        {% for error in form.latlon_flag.errors %}
                                        <div class="has-error help-block text-danger">{{ error }}</div>
                                        {% endfor %}
                                        {% endif %}



                                    </div>

                                </div>
                            </div>

                            </div> <!-- location widgets -->
                            <div class="col-md-6" >
                                <p>1) Or place the marker where the recapture occured

                                    <a href="#myModal" role="button" class="btn btn-info btn-xs" data-toggle="modal">
                                        <span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Enlarge Map</a>

                                </p>
                                <div id="main_map" style="width: 500px; height: 500px;"></div>
                                <p class="pull-right"  id="latlon_text"></p>
                            </div> <!-- map column-->
                        </div>

                    </div><!-- Recovery Panel -->
                </div> <!-- Recovery Location Panel-->

                <div id="fish_row" class="row" >

                    <div id="fish_col" class="col-md-6" >
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Fish Attributes</h3>
                            </div>
                            <div class="panel-body">

                                <div id="fate_row" class="row" >
                                    <div class="col-md-3 text-right" >
                                        {{ form.fate.label_tag }}
                                    </div>
                                    <div class="col-md-3" >
                                        <div class="form-group {% if form.fate.errors %}has-error{% endif %}">

                                            {{ form.fate }}
                                            {% if form.fate.errors %}
                                            {% for error in form.fate.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>


                                    <div class="col-md-6" >
                                        <label for="tag_removed">Tag Removed:</label>
                                        <label class="radio-inline">
                                            <input type="radio" name="tag_removed" id="id_tag_removed_true" value="true"> Yes
                                        </label>
                                        <label class="radio-inline">
                                            <input type="radio" name="tag_removed" id="id_tag_removed_false" value="false" checked> No
                                        </label>
                                    </div>
                                </div>

                                <div id="tlen_row" class="row" >
                                    <div class="col-md-3 text-right" >
                                        {{ form.tlen.label_tag }}
                                    </div>
                                    <div class="col-md-3" >
                                        <div class="form-group {% if form.tlen.errors %}has-error{% endif %}">

                                            {{ form.tlen }}
                                            <input type="text" class="form-control imperial" id="id_tlen_inches" placeholder="inches">
                                            {% if form.tlen.errors %}
                                            {% for error in form.tlen.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6" >
                                        <label class="radio-inline">
                                            <input type="radio" name="tlen_units" id="tlen_units_inches" value="inches"> Inches
                                        </label>
                                        <label class="radio-inline">
                                            <input type="radio" name="tlen_units" id="tlen_units_mm" value="mm" checked> mm
                                        </label>
                                    </div>
                                </div>


                                <div id="flen_row" class="row" >
                                    <div class="col-md-3 text-right" >
                                        {{ form.flen.label_tag }}
                                    </div>
                                    <div class="col-md-3" >
                                        <div class="form-group {% if form.flen.errors %}has-error{% endif %}">

                                            {{ form.flen }}
                                            <input type="text" class="form-control imperial" id="id_flen_inches" placeholder="inches">
                                            {% if form.flen.errors %}
                                            {% for error in form.flen.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6" >
                                        <label class="radio-inline">
                                            <input type="radio" name="flen_units" id="flen_units_inches" value="inches"> Inches
                                        </label>
                                        <label class="radio-inline">
                                            <input type="radio" name="flen_units" id="flen_units_mm" value="mm" checked> mm
                                        </label>
                                    </div>
                                </div>

                                <div id="rwt_row" class="row" >
                                    <div class="col-md-3 text-right" >
                                        {{ form.rwt.label_tag }}
                                    </div>
                                    <div class="col-md-3" >
                                        <div class="form-group {% if form.rwt.errors %}has-error{% endif %}">

                                            {{ form.rwt }}
                                            <input type="text" class="form-control imperial" id="id_rwt_lbs" placeholder="pounds">
                                            {% if form.rwt.errors %}
                                            {% for error in form.rwt.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6" >
                                        <label class="radio-inline">
                                            <input type="radio" name="rwt_units" id="rwt_units_lbs" value="lbs"> lbs
                                        </label>
                                        <label class="radio-inline">
                                            <input type="radio" name="rwt_units" id="rwt_units_g" value="g" checked> g
                                        </label>
                                    </div>
                                </div>


                                <div id="girth_row" class="row" >
                                    <div class="col-md-3 text-right" >
                                        {{ form.girth.label_tag }}
                                    </div>
                                    <div class="col-md-3" >
                                        <div class="form-group {% if form.girth.errors %}has-error{% endif %}">

                                            {{ form.girth }}
                                            <input type="text" class="form-control imperial" id="id_girth_inches" placeholder="inches">
                                            {% if form.girth.errors %}
                                            {% for error in form.girth.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6" >
                                        <label class="radio-inline">
                                            <input type="radio" name="girth_units" id="girth_units_inches" value="inches"> Inches
                                        </label>
                                        <label class="radio-inline">
                                            <input type="radio" name="girth_units" id="girth_units_mm" value="mm" checked> mm
                                        </label>
                                    </div>
                                </div>



                                <div id="sex_row" class="row" >
                                    <div class="col-md-3 text-right" >
                                        {{ form.sex.label_tag }}
                                    </div>
                                    <div class="col-md-3" >
                                        <div class="form-group {% if form.sex.errors %}has-error{% endif %}">

                                            {{ form.sex }}
                                            {% if form.sex.errors %}
                                            {% for error in form.sex.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div id="clipc_row" class="row" >
                                    <div class="col-md-3 text-right" >
                                        {{ form.clipc.label_tag }}
                                    </div>
                                    <div class="col-md-3" >
                                        <div id="clipc_input" class="form-group {% if form.clipc.errors %}has-error{% endif %}">
                                            {{ form.clipc }}
                                            {% if form.clipc.errors %}
                                            {% for error in form.clipc.errors %}
                                            <div class="has-error help-block text-danger">{{ error }}</div>
                                            {% endfor %}
                                            {% endif %}
                                        </div>
                                        <div id="clipc_error" class="alert alert-danger" role="alert">
                                            <div id="clipc_error_text">Invalid Clip Code.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2" >
                                        <a class="btn btn-primary" role="button" data-toggle="collapse" href="#collapseClipC" aria-expanded="false" aria-controls="collapseClipC">
                                            Show Clip Codes
                                        </a>
                                    </div>
                                </div>

                                <div class="collapse" id="collapseClipC">
                                    <div class="well">

                                        {% for key, value in clip_codes %}
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="clipc_group[]" value="{{ key }}">{{ value }} ({{ key }})
                                            </label>
                                        </div>
                                        {% endfor %}

                                    </div>  <!-- class well -->
                                </div> <!-- class collapse -->

                            </div> <!-- Fish Panel -->
                        </div> <!-- fish column -->
                    </div>

                    <div id="comments_column" class="col-md-6" >
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Additional Comments</h3>
                            </div>
                            <div class="panel-body">

                                <div class="alert alert-warning" id="derived_comment" role="alert">
                                    <p>Please describe how the recapture location was derived.</p>
                                </div>

                                <!-- <div id="fish_comments" class="col-md-6" > -->
                                <div class="form-group {% if form.comment.errors %}has-error{% endif %}">
                                    {{ form.comment }}
                                    {% if form.comment.errors %}
                                    {% for error in form.comment.errors %}
                                    <div class="has-error help-block text-danger">{{ error }}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> <!-- Comments Pforanel -->
                    </div> <!-- Comments Column -->
                </div>

                <hr />


                <input class="btn btn-primary pull-right" type="submit" value="Submit">

            </form>


        </div>
    </div>
</div>


<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-heformader">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Recapture Location</h4>
            </div>
            <div class="modal-body">
                <div id="popup_map" style="width: 900px; height: 700px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary popup-submit">Submit</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


(
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="/static/Leaflet.MakiMarkers.js"></script>
<script src="/static/grids.js"></script>


<script type="text/javascript">

 $(document).ready(function(){

     //make sure all of the error messages are hidden when we load the form:

     clear_lat_long_errors();
     $( "#clipc_error" ).hide();
     $( "#tagdoc_length" ).hide();
     $( "#tagtype_error" ).hide();
     $( "#tagposition_error" ).hide();
     $( "#tagorigin_error" ).hide();
     $( "#tagcolour_error" ).hide();
     $( "#derived_comment" ).hide();

     update_tagoptions();

     //start with metric input visible if this is an existing record
     // most of our recoveries are from anglers - use imperial units for new reports
     {% if action == "edit" %}
     $('.metric').show();
     $('.imperial').hide();
     $('#flen_units_mm').prop('checked', true)
     $('#tlen_units_mm').prop('checked', true)
     $('#rwt_units_g').prop('checked', true)
     $('#girth_units_mm').prop('checked', true)
     $('#flen_units_inches').prop('checked', false)
     $('#tlen_units_inches').prop('checked', false)
     $('#rwt_units_lbs').prop('checked', false)
     $('#girth_units_inches').prop('checked', false)

     {% else %}
     // imperial
     $('.metric').hide();
     $('.imperial').show();
     $('#flen_units_mm').prop('checked', false)
     $('#tlen_units_mm').prop('checked', false)
     $('#girth_units_mm').prop('checked', false)
     $('#rwt_units_g').prop('checked', false)
     $('#flen_units_inches').prop('checked', true)
     $('#tlen_units_inches').prop('checked', true)
     $('#rwt_units_lbs').prop('checked', true)
     $('#girth_units_inches').prop('checked', true)

     {% endif %}

     // intantiate the metric/imperial fish attributes cells:
     girth_mm2inches();
     girth_inches2mm();

     tlen_mm2inches();
     tlen_inches2mm();

     flen_mm2inches();
     flen_inches2mm();

     rwt_g2lbs();
     rwt_lbs2g();



     var my_map;
     var popup_map;
     var my_markers = new Array();
     var popup_markers = new Array();

     // marker arrays - when we click on the map, create a new marker with the coordinates of the click
     // delete any existing markers in the array
     // add the new marker to the array.


     // we will use the same 'custom' marker everywhere (the blue
     // default is hard to see over blue water).
     var icon = L.MakiMarkers.icon({icon: "marker", color: "#b0b", size: "m"});

     initmap();
     refresh_map();

     function clear_lat_long_errors(){
         $( "#dd_lat_deg_error" ).hide();
         $( "#dd_lon_deg_error" ).hide();

         $( "#dms_lat_deg_error" ).hide();
         $( "#dms_lat_min_error" ).hide();
         $( "#dms_lat_sec_error" ).hide();

         $( "#dms_lon_deg_error" ).hide();
         $( "#dms_lon_min_error" ).hide();
         $( "#dms_lon_sec_error" ).hide();

         $( "#ddm_lat_deg_error" ).hide();
         $( "#ddm_lat_min_error" ).hide();

         $( "#ddm_lon_deg_error" ).hide();
         $( "#ddm_lon_min_error" ).hide();

         $( "#grid_no_error" ).hide();
     }



     function get_grid_number(ddlat, ddlon){
         // for now clear the grid number if the point comes from any-other control
         // someday we will call get_grid api and pass in the coordinates to get it.
         $('input[id="grid_no"]').val('');

     };


     function refresh_map(){
         // anytime one of the text box controls change (with a valid
         // value) we need to update the marker on our map

         var ddlat = parseFloat($('input[id="id_dd_lat"]').val());
         var ddlon = parseFloat($('input[id="id_dd_lon"]').val());


         if(isNaN(ddlat)===false && isNaN(ddlon)===false){

             get_grid_number(ddlat, ddlon);

             $('input:radio[name="latlon_flag"]').val(["1"]); // 1 == 'Reported'

             var pt = L.latLng(ddlat, ddlon);
             clear_lat_long_errors();

             //if the length of our marker array is more than , we have a
             if (my_markers.length && typeof my_markers[0] !== 'undefined'){
                 my_map.removeLayer(my_markers[0]);
                 delete my_markers[0];
             }

             var marker = L.marker(pt,{icon:icon});
             my_map.addLayer(marker);
             my_markers[0] = marker;

             my_map.panTo(marker.getLatLng());
         }
     }

     function initmap(){
         // we will initialize the map over lake huron - this could be customized at some point in the future.
         my_map = new L.map('main_map').setView([45,-82], 7);

         L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWNvdHRyaWxsIiwiYSI6ImNpazVmb3Q2eDAwMWZpZm0yZTQ1cjF3NTkifQ.Pb1wCYs0lKgjnTGz43DjVQ'
, {
             maxZoom: 18,
             attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                          'Imagery  <a href="http://mapbox.com">Mapbox</a>',
             id: 'mapbox.streets'
         }).addTo(my_map);

     };

     function clear_spatial_controls(){
         // if the grid and lake we selected don't exist.  clear any
         //existing information in the lat-long controls.
         if (my_markers.length && typeof my_markers[0] !== 'undefined'){
             my_map.removeLayer(my_markers[0]);
             delete my_markers[0];
         }

         $('input[id="id_dd_lat"]').val('');

         $('input[id="ddm_lat_deg"]').val('');
         $('input[id="ddm_lat_min"]').val('');

         $('input[id="dms_lat_deg"]').val('');
         $('input[id="dms_lat_min"]').val('');
         $('input[id="dms_lat_sec"]').val('');

         $('input[id="id_dd_lon"]').val('');

         $('input[id="ddm_lon_deg"]').val('');
         $('input[id="ddm_lon_min"]').val('');

         $('input[id="dms_lon_deg"]').val('');
         $('input[id="dms_lon_min"]').val('');
         $('input[id="dms_lon_sec"]').val('');

         // the coordinates under the map:
         $("#latlon_text").html('');


     }


     function update_controls(dd_lat, dd_lon){
         // when we get a new lat-long - either from a click on our main map, or a submission from our popup-map,
         // we need to update the main map and then update each of the lat-long controls.

         // Every time when user click on map we want to update
         // the marker with the new position where the user clicked
         var pt = L.latLng(dd_lat, dd_lon);

         clear_lat_long_errors();

         $('input:radio[name="latlon_flag"]').val(["1"]); // 1 == 'Reported'

         //if the length of our marker array is more than 0 or the first element is not
         //undefined, we have a point to remove and delete
         if (my_markers.length && typeof my_markers[0] !== 'undefined'){
             my_map.removeLayer(my_markers[0]);
             delete my_markers[0];
         }

         var marker = L.marker(pt,{icon:icon});
         my_map.addLayer(marker);
         my_markers[0] = marker;

         my_map.panTo(pt);

         //update the other input values with the coordinates from the map marker:
         var lat_idegrees = Math.floor(dd_lat);
         var lat_dminutes = (dd_lat - lat_idegrees) * 60;
         var lat_iminutes = Math.floor(lat_dminutes);
         var lat_seconds = (lat_dminutes - lat_iminutes) * 60;

         $('input[id="id_dd_lat"]').val(dd_lat);

         $('input[id="ddm_lat_deg"]').val(lat_idegrees);
         $('input[id="ddm_lat_min"]').val(lat_dminutes);

         $('input[id="dms_lat_deg"]').val(lat_idegrees);
         $('input[id="dms_lat_min"]').val(lat_iminutes);
         $('input[id="dms_lat_sec"]').val(lat_seconds);

         ddlon = Math.abs(dd_lon);
         var lon_idegrees = Math.floor(ddlon);
         var lon_dminutes = (ddlon - lon_idegrees) * 60;
         var lon_iminutes = Math.floor(lon_dminutes);
         var lon_seconds = (lon_dminutes - lon_iminutes) * 60;

         $('input[id="id_dd_lon"]').val(ddlon * -1);

         $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);
         $('input[id="ddm_lon_min"]').val(lon_dminutes);

         $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);
         $('input[id="dms_lon_min"]').val(lon_iminutes);
         $('input[id="dms_lon_sec"]').val(lon_seconds);


         // the coordinates under the map:
         $("#latlon_text").html('<em>' +  dd_lat.toFixed(4) + '&deg;N ' + dd_lon.toFixed(4) + '&deg;W</em>');

         // when we have a grid api we can update the grid and lake based on the Coordinates
         // we could do that here.

     }


     // from http://ipasic.com/article/let-user-add-point-map-geodjango-leaflet/
     function onMapClick(e) {
         // capture the click events on our map an update the other controls accordingly
         var dd_lat = e.latlng.lat;
         var dd_lon = e.latlng.lng;

         update_controls(dd_lat, dd_lon);
         get_grid_number(dd_lat, dd_lon)

     }

     // call the onMapClick function when user click on map
     my_map.on('click', onMapClick);


     function init_popup_map(){

         // initialize the popup map with the current settings of the main map:
         //popup_map = new L.map('popup_map').setView(my_map.getCenter(), my_map.getZoom());
         if (typeof popup_map == 'undefined'){
             popup_map = new L.map('popup_map')
         }
         popup_map.setView(my_map.getCenter(), my_map.getZoom());

         L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYWNvdHRyaWxsIiwiYSI6ImNpazVmb3Q2eDAwMWZpZm0yZTQ1cjF3NTkifQ.Pb1wCYs0lKgjnTGz43DjVQ', {
             maxZoom: 18,
             attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                          'Imagery  <a href="http://mapbox.com">Mapbox</a>',
             id: 'mapbox.streets'
         }).addTo(popup_map);


         if (my_markers.length && typeof my_markers[0] != 'undefined') {
             var pt = my_markers[0].getLatLng();

             //if the length of our marker array is more than , we have a
             if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
                 popup_map.removeLayer(popup_markers[0]);
                 delete popup_markers[0];
             }

             var marker = L.marker(pt,{icon:icon});
             popup_map.addLayer(marker);
             popup_markers[0] = marker;
             popup_map.panTo(pt);
         }


     };

     function onPopupMapClick(e) {
         // capture the location of any clicks on our popup map and put the point there
         var dd_lat = e.latlng.lat;
         var dd_lon = e.latlng.lng;

         var pt = L.latLng(dd_lat, dd_lon);

         if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
             popup_map.removeLayer(popup_markers[0]);
             delete popup_markers[0];
         }

         var marker = L.marker(pt,{icon:icon});
         popup_map.addLayer(marker);
         popup_markers[0] = marker;


     };


     // when we open the modal dialog, initialize a map and associated click events with our function.
     $('#myModal').on('shown.bs.modal',function(){
         init_popup_map();
         popup_map.on('click', onPopupMapClick);
     });

     $(function () {
         // if the submit button the popup form is clicked, get the
         //coordinates from the marker (if it exists) and
         // update all of the lat-lon controls
         $('body').on('click', '.popup-submit', function (e) {

             if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
                 var pt = popup_markers[0].getLatLng();
                 update_controls(pt.lat, pt.lng);
                 get_grid_number(pt.lat, pt.lng);
             }

             //finally hide the popup map:
             $('#myModal').modal('hide');

         });
     });


     $('input[id="id_dd_lat"]').change (function () {

         var ddlat = parseFloat($('input[id="id_dd_lat"]').val());

         var valid = check_dd_lat(ddlat);
         if (valid){
             var lat_idegrees = Math.floor(ddlat);
             var lat_dminutes = (ddlat - lat_idegrees) * 60;
             var lat_iminutes = Math.floor(lat_dminutes);
             var lat_seconds = (lat_dminutes - lat_iminutes) * 60;

             $('input[id="ddm_lat_deg"]').val(lat_idegrees);
             $('input[id="ddm_lat_min"]').val(lat_dminutes);

             $('input[id="dms_lat_deg"]').val(lat_idegrees);
             $('input[id="dms_lat_min"]').val(lat_iminutes);
             $('input[id="dms_lat_sec"]').val(lat_seconds);

             refresh_map();
         }


     });


     var grid_change = function(){
         // see if a point exists in our grid lookup-key
         var lake = $('#lake_name').find(':selected').text().split(" ")[1];
         var grid_no = parseInt($('input[name="grid_no"]').val());
         var coord;
         if (grids[lake]){
             coord = grids[lake][grid_no];
         }

         if (coord){
             update_controls(coord[1], coord[0]);
             $( "#grid_no_error" ).hide();
         } else {
             clear_spatial_controls();
             $( "#grid_no_error" ).show();
         }

     };

     $('#lake_name').on('change', function(){
         console.log('Lake Changed!')
         grid_change();
     });


     $('input[name="grid_no"]').focusout(function(){
         grid_change();
     });



     $('input[id="id_dd_lon"]').change (function () {

         var ddlon = parseFloat($('input[id="id_dd_lon"]').val());

         var valid = check_dd_lon(ddlon);

         if (valid){
             ddlon = Math.abs(ddlon);
             var lon_idegrees = Math.floor(ddlon);
             var lon_dminutes = (ddlon - lon_idegrees) * 60;
             var lon_iminutes = Math.floor(lon_dminutes);
             var lon_seconds = (lon_dminutes - lon_iminutes) * 60;

             $('input[id="id_dd_lon"]').val(ddlon * -1);

             $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="ddm_lon_min"]').val(lon_dminutes);

             $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="dms_lon_min"]').val(lon_iminutes);
             $('input[id="dms_lon_sec"]').val(lon_seconds);

             refresh_map();
         }
     });



     function check_dms_lat( lat_degrees, lat_minutes, lat_seconds){

         // if both ddm_lat_deg and ddm_lon_min are populated, we need to check their values
         // if only one is populated, do nothing (for now)
         // if their values are ok, update the other, related controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90

         // degrees must be an integer between 90 and 90
         if(isNaN(lat_degrees) || parseInt(lat_degrees)!==lat_degrees ||
                                                          lat_degrees <-90 ||
                                                          lat_degrees > 90){
                                                              $( "#dms_lat_deg_error" ).show();
                                                              $( "#dms_lat_deg" ).addClass("has-error");
                                                              return false
         } else {
             $( "#dms_lat_deg_error" ).hide();
             $( "#dms_lat_deg" ).removeClass("has-error");
         }

         // minutes must be an integer between 0 and 59.999
         if(isNaN(lat_minutes) || parseInt(lat_minutes)!==lat_minutes ||
                                                          lat_minutes < 0 || lat_minutes >=60){
                                                              $( "#dms_lat_min_error" ).show();
                                                              $( "#dms_lat_min" ).addClass("has-error");
                                                              return false
         } else {
             $( "#dms_lat_min_error" ).hide();
             $( "#dms_lat_min" ).removeClass("has-error");
         }


         if(isNaN(lat_seconds) || lat_seconds < 0 || lat_seconds >=60){
             $( "#dms_lat_sec_error" ).show();
             $( "#dms_lat_sec" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lat_sec_error" ).hide();
             $( "#dms_lat_sec" ).removeClass("has-error");
         }

         return true
     }



     function check_dd_lat(lat_degrees){
         // check_dd_lat
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90


         if(isNaN(lat_degrees) || lat_degrees< -90 || lat_degrees> 90){
             $( "#dd_lat_deg_error" ).show();
             $( 'input[id="id_dd_lat"]' ).addClass("has-error");
             return false
         } else {
             $( "#dd_lat_deg_error" ).hide();
             $( 'input[id="id_dd_lat"]' ).removeClass("has-error");
         }

         return true
     }


     function check_dd_lon(lon_degrees){
         // check_dd_lon
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90


         if(isNaN(lon_degrees) || lon_degrees < -180 || lon_degrees> 180){
             $( "#dd_lon_deg_error" ).show();
             $( 'input[id="id_dd_lon"]' ).addClass("has-error");
             return false
         } else {
             $( "#dd_lon_deg_error" ).hide();
             $( 'input[id="id_dd_lon"]' ).removeClass("has-error");
         }

         return true
     }



     function check_dms_lon( lon_degrees, lon_minutes, lon_seconds){

         // if both ddm_lon_deg and ddm_lon_min are populated, we need to check their values
         // if only one is populated, do nothing (for now)
         // if their values are ok, update the other, reloned controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90

         // degrees must be an integer between 90 and 90
         if(isNaN(lon_degrees) || parseInt(lon_degrees)!==lon_degrees ||
                                                          lon_degrees <-90 ||
                                                          lon_degrees > 90){
                                                              $( "#dms_lon_deg_error" ).show();
                                                              $( "#dms_lon_deg" ).addClass("has-error");
                                                              return false
         } else {
             $( "#dms_lon_deg_error" ).hide();
             $( "#dms_lon_deg" ).removeClass("has-error");
         }

         // minutes must be an integer between 0 and 59.999
         if(isNaN(lon_minutes) || parseInt(lon_minutes)!==lon_minutes ||
                                                          lon_minutes < 0 || lon_minutes >=60){
                                                              $( "#dms_lon_min_error" ).show();
                                                              $( "#dms_lon_min" ).addClass("has-error");
                                                              return false
         } else {
             $( "#dms_lon_min_error" ).hide();
             $( "#dms_lon_min" ).removeClass("has-error");
         }


         if(isNaN(lon_seconds) || lon_seconds < 0 || lon_seconds >=60){
             $( "#dms_lon_sec_error" ).show();
             $( "#dms_lon_sec" ).addClass("has-error");
             return false
         } else {
             $( "#dms_lon_sec_error" ).hide();
             $( "#dms_lon_sec" ).removeClass("has-error");
         }

         return true
     }


     function check_ddm_lat( lat_idegrees, lat_dminutes){
         // check_ddm_lat

         // if both ddm_lat_deg and ddm_lon_min are populated, we need to check their values
         // if only one is populated, do nothing (for now)
         // if their values are ok, update the other, related controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -90 and 90


         if(isNaN(lat_idegrees) || parseInt(lat_idegrees)!==lat_idegrees ||
                                                            lat_idegrees< -90 ||
                                                            lat_idegrees> 90){
                                                                $( "#ddm_lat_deg_error" ).show();
                                                                $( "#ddm_lat_deg" ).addClass("has-error");
                                                                return false
         } else {
             $( "#ddm_lat_deg_error" ).hide();
             $( "#ddm_lat_deg" ).removeClass("has-error");
         }

         if(isNaN(lat_dminutes) || lat_dminutes < 0 || lat_dminutes >=60){
             $( "#ddm_lat_min_error" ).show();
             $( "#ddm_lat_min" ).addClass("has-error");
             return false
         } else {
             $( "#ddm_lat_min_error" ).hide();
             $( "#ddm_lat_min" ).removeClass("has-error");
         }

         return true
     }

     function check_ddm_lon( lon_idegrees, lon_dminutes){
         // check_ddm_lon

         // if both ddm_lon_deg and ddm_lon_min are populated, we need to check their values
         // if only one is populated, do nothing (for now)
         // if their values are ok, update the other, related controls and the map
         // if there problems with their values, issue a meaningful error message
         // to be valid:
         // both degrees and minutes must be populated
         // minutes must be a float between 0 and 60
         // degrees must be an integer between -180 and 180

         if(isNaN(lon_idegrees) || parseInt(lon_idegrees)!==lon_idegrees ||
                                                            lon_idegrees < -180 ||
                                                            lon_idegrees >=180){
                                                                $( "#ddm_lon_deg_error" ).show();
                                                                $( "#ddm_lon_deg" ).addClass("has-error");
                                                                return false
         } else {
             $( "#ddm_lon_deg_error" ).hide();
             $( "#ddm_lon_deg" ).removeClass("has-error");
         }

         if(isNaN(lon_dminutes) || lon_dminutes < 0 || lon_dminutes >=60){
             $( "#ddm_lon_min_error" ).show();
             $( "#ddm_lon_min" ).addClass("has-error");
             return false
         } else {
             $( "#ddm_lon_min_error" ).hide();
             $( "#ddm_lon_min" ).removeClass("has-error");
         }

         return true
     }




     $('input[name="ddm_lat"]').change (function () {


         //if any of the latitude elements on the ddm page change, update the other formats.
         var lat_idegrees = parseFloat($('input[id="ddm_lat_deg"]').val());
         var lat_dminutes = parseFloat($('input[id="ddm_lat_min"]').val());

         var valid = check_ddm_lat(lat_idegrees, lat_dminutes);

         if(valid){

             // update the controls on the dd tab
             ddlat = lat_idegrees + lat_dminutes / 60;
             $('input[id="id_dd_lat"]').val(ddlat);

             var lat_iminutes = Math.floor(lat_dminutes);
             var lat_seconds = (lat_dminutes - lat_iminutes) * 60;

             // update the controls on the dms tab
             $('input[id="dms_lat_deg"]').val(lat_idegrees);
             $('input[id="dms_lat_min"]').val(lat_iminutes);
             $('input[id="dms_lat_sec"]').val(lat_seconds);

             refresh_map();
         }
     });

     $('input[name="ddm_lon"]').change (function () {
         //if any of the longitude elements on the ddm page change, update the other formats.
         var lon_idegrees = parseFloat($('input[id="ddm_lon_deg"]').val());
         lon_idegrees = Math.abs(lon_idegrees);
         var lon_dminutes = parseFloat($('input[id="ddm_lon_min"]').val());

         var valid = check_ddm_lon(lon_idegrees, lon_dminutes);

         if(valid){

             $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);

             // calculate decimal degrees and update the dd tab
             var ddlon = (lon_idegrees + lon_dminutes / 60);
             $('input[id="id_dd_lon"]').val(ddlon * -1);

             var lon_iminutes = Math.floor(lon_dminutes);
             var lon_seconds = (lon_dminutes - lon_iminutes) * 60;
             // update the controls on the dms tab
             $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="dms_lon_min"]').val(lon_iminutes);
             $('input[id="dms_lon_sec"]').val(lon_seconds);

             refresh_map();
         }

     });


     $('input[name="dms_lat"]').change (function () {
         //if any of the latitude elements on the dms page change, update the other formats.

         var lat_idegrees = parseFloat($('input[id="dms_lat_deg"]').val());
         var lat_iminutes = parseFloat($('input[id="dms_lat_min"]').val());
         var lat_seconds = parseFloat($('input[id="dms_lat_sec"]').val());

         var valid = check_dms_lat(lat_idegrees, lat_iminutes, lat_seconds);

         if (valid===true){

             // ddm tab
             var lat_dminutes = lat_iminutes + lat_seconds / 60;
             $('input[id="ddm_lat_deg"]').val(lat_idegrees);
             $('input[id="ddm_lat_min"]').val(lat_dminutes);

             // decimal degree tab
             var ddlat = lat_idegrees + lat_dminutes / 60;
             $('input[id="id_dd_lat"]').val(ddlat);

             refresh_map();
         }

     });

     $('input[name="dms_lon"]').change (function () {
         //if any of the longitude elements on the dms page change, update the other formats.

         var lon_idegrees = parseFloat($('input[id="dms_lon_deg"]').val());
         var lon_iminutes = parseFloat($('input[id="dms_lon_min"]').val());
         var lon_seconds = parseFloat($('input[id="dms_lon_sec"]').val());

         var valid = check_dms_lon(lon_idegrees, lon_iminutes, lon_seconds);

         if (valid===true){

             lon_idegrees = Math.abs(lon_idegrees);

             $('input[id="dms_lon_deg"]').val(lon_idegrees * -1);

             // ddm tab
             var lon_dminutes = lon_iminutes + lon_seconds / 60;
             $('input[id="ddm_lon_deg"]').val(lon_idegrees * -1);
             $('input[id="ddm_lon_min"]').val(lon_dminutes);

             // decimal degree tab
             var ddlon = lon_idegrees + lon_dminutes / 60;
             $('input[id="id_dd_lon"]').val(ddlon * -1);

             refresh_map();
         }
     });




     function check_len_tagdoc(tagdoc_val){
         if (tagdoc_val.length != 5) {
             //update tagdoc elements with bootstrap errors
             $( "#tagdoc_input" ).addClass( "has-error");
             $( "#tagdoc_length" ).show();
             return false;
         } else {
             //clear any existing bootstrap errors
             $( "#tagdoc_input" ).removeClass("has-error");
             $( "#tagdoc_length" ).hide();
             return true
         }
     }

     function check_tagtype(tagtype){
         if ($('input[name="tagtype_options"][value="' + tagtype + '"]').length){
             $( "#tagtype_error" ).hide();
             $( "#tagtype_panel" ).removeClass("has-error");
         } else {
             $( "#tagtype_error_text").text("'" + tagtype + "' is not a valid Tag Type.")
                 $( "#tagtype_error" ).show();
             $( "#tagtype_panel" ).addClass("has-error");
         }
     }


     function check_tagposition(tagposition){
         if ($('input[name="tagposition_options"][value="' + tagposition + '"]').length){
             $( "#tagposition_error" ).hide();
             $( "#tagposition_panel" ).removeClass("has-error");
         } else {
             $( "#tagposition_error_text").text("'" + tagposition + "' is not a valid Tag Position")
                 $( "#tagposition_error" ).show();
             $( "#tagposition_panel" ).addClass("has-error");

         }
     }

     function check_tagcolour(tagcolour){
         if ($('input[name="tagcolour_options"][value="' + tagcolour + '"]').length){
             $( "#tagcolour_error" ).hide();
             $( "#tagcolour_panel" ).removeClass("has-error");
         } else {
             $( "#tagcolour_error_text").text("'" + tagcolour + "' is not a valid Tag Colour")
                 $( "#tagcolour_error" ).show();
             $( "#tagcolour_panel" ).addClass("has-error");
         }
     }


     function check_tagorigin(tagorigin){
         if ($('input[name="tagorigin_options"][value="' + tagorigin + '"]').length){
             $( "#tagorigin_error" ).hide();
             $( "#tagorigin_panel" ).removeClass("has-error");
         } else {
             $( "#tagorigin_error_text").text("'" + tagorigin + "' is not a valid Agency Code")
                 $( "#tagorigin_error" ).show();
             $( "#tagorigin_panel" ).addClass("has-error");
         }
     }



     function update_tagoptions() {
         var tagdoc_val = $('input[id="id_tagdoc"]').val().toUpperCase();

         var valid = check_len_tagdoc(tagdoc_val);
         if (valid===false){
             return;
         }

         var tagtype = tagdoc_val[0];
         var position = tagdoc_val[1];
         var origin = tagdoc_val.substring(2,4);
         var colour = tagdoc_val[4];

         // now make sure that each of the tag attributes actually exist in the list.
         // update the radio buttons accordingly and issue a meaninful error if not.
         check_tagtype(tagtype);
         $('input[name="tagtype_options"]').val([tagtype]);
         check_tagposition(position);
         $('input[name="tagposition_options"]').val([position]);
         check_tagorigin(origin);
         $('input[name="tagorigin_options"]').val([origin]);
         check_tagcolour(colour);
         $('input[name="tagcolour_options"]').val([colour]);

         $('input[id="id_tagdoc"]').val(tagdoc_val);

     };


     function checkForUnique(str){
         //from:https://ujjaini.wordpress.com/2014/09/04/check-if-a-string-has-
         //    all-unique-characters-in-javascript/
         var hashtable = {};
         for(var i=0,len=str.length;i<len;i++){
             if (hashtable[str[i]] != null){
                 hashtable[str[i]] = 1;
                 return false;
             }else{
                 hashtable[str[i]] = 0;
             }
         }
         return true;
     }


     // METRIC-IMPERIAL Fucntions
     // these functions populate their metric-imperial counterpart
     // called when page is created and when a units radio button is clicked


     function girth_mm2inches(){
         var girth = parseFloat($('input[id="id_girth"]').val());
         var girth_inches = girth / 25.4 || "";
         $('input[id="id_girth_inches"]').val(girth_inches);
     }

     function girth_inches2mm(){
         var girth_inches = parseFloat($('input[id="id_girth_inches"]').val());
         var girth = Math.round(girth_inches * 25.4) || "";
         $('input[id="id_girth"]').val(girth);
     }


     function tlen_mm2inches(){
         var tlen = parseFloat($('input[id="id_tlen"]').val());
         var tlen_inches = tlen / 25.4 || "";
         $('input[id="id_tlen_inches"]').val(tlen_inches);
     }

     function tlen_inches2mm(){
         var tlen_inches = parseFloat($('input[id="id_tlen_inches"]').val());
         var tlen = Math.round(tlen_inches * 25.4) || "";
         $('input[id="id_tlen"]').val(tlen);
     }

     function flen_mm2inches(){
         var flen = parseFloat($('input[id="id_flen"]').val());
         var flen_inches = flen / 25.4 || "";
         $('input[id="id_flen_inches"]').val(flen_inches);
     }

     function flen_inches2mm(){
         var flen_inches = parseFloat($('input[id="id_flen_inches"]').val());
         var flen = Math.round(flen_inches * 25.4) || "";
         $('input[id="id_flen"]').val(flen);
     }

     function rwt_g2lbs(){
         var rwt = parseFloat($('input[id="id_rwt"]').val());
         var rwt_lbs = rwt / 453.592 || "";
         $('input[id="id_rwt_lbs"]').val(rwt_lbs);
     }

     function rwt_lbs2g(){
         var rwt_lbs = parseFloat($('input[id="id_rwt_lbs"]').val());
         var rwt = Math.round(rwt_lbs * 453.592) || "";
         $('input[id="id_rwt"]').val(rwt);
     }


     $('input[type="radio"]').on('click change', function(e) {
         /// if one of the tagdoc_radio buttons change, refresh the tagdoc input
         var colour = $('input:radio[name="tagcolour_options"]:checked').val() || '?';
         var position = $('input:radio[name="tagposition_options"]:checked').val()  || '?';
         var origin = $('input:radio[name="tagorigin_options"]:checked').val() || '?';
         var tagtype = $('input:radio[name="tagtype_options"]:checked').val() || '?';
         var tagdoc = tagtype + position + origin + colour

         $('input[id="id_tagdoc"]').val(tagdoc);

         //clears any old errors that may be hanging around
         var valid = check_len_tagdoc(tagdoc);
         if (valid) {
             check_tagtype(tagtype);
             check_tagposition(position);
             check_tagorigin(origin);
             check_tagcolour(colour);
         }

     });

     // if the tagdoc changes, parse it's content, verify that it
     // is 5 characters in length, and that each character corresponds
     // to one of radio button options - if so, update the radio
     // buttons, if not, give a meaningful error message.

     $('input[id="id_tagdoc"]').change (update_tagoptions);

     $('input[id="id_clipc"]').change (function () {
         //if clipc changes we need to check its value, update
         //the check boxes accordingly, and issue an error if
         //clipc contains a value that does not correspond to to
         //a clip code.  If all of the values in clipc
         //correspond to actual clips, replace clipc with an
         //equivalent value that is sorted correctly (13 not 31)

         var clipc = $('input[id="id_clipc"]').val().toUpperCase();

         // first we need to make sure that clipc is valid:
         // to be valid, it can't have any characters that repeat
         // can't have any characters that don't have a corresponding checkbox

         var valid = checkForUnique(clipc);
         var chkbox;

         if (valid){
             for (i = 0; i < clipc.length; i++) {
                 x = clipc[i];
                 chkbox = $('input[name="clipc_group[]"][value="' + x + '"]');

                 if (chkbox.length===0){
                     valid = false;
                     break;
                 }
             }
         }

         if (valid===false){
             $( "#clipc_error_text").text("'" + clipc + "' is not a valid Clip Code");
             $( "#clipc_error" ).show();
             $( "#clipc_input" ).addClass("has-error");
             return;
         } else {
             $( "#clipc_error" ).hide();
             $( "#clipc_input" ).removeClass("has-error");

             if (clipc===''){
                 //reset all of the checkboxes to false
                 $('input:checkbox[name="clipc_group[]"]').prop('checked',false);

             } else if (clipc.indexOf('0') !== -1) {
                 // if the clip code contains 0, reset everything but 0
                 $('input[id="id_clipc"]').val("0");
                 $('input:checkbox[name="clipc_group[]"][value!=0]').prop('checked',false);
                 $('input:checkbox[name="clipc_group[]"][value=0]').prop('checked', true);

             } else {

                 var x;

                 //clear our old selections:
                 $('input:checkbox[name="clipc_group[]"]').prop('checked', false);
                 //check each of the new ones:
                 for (i = 0; i < clipc.length; i++) {
                     x = clipc[i].toString();
                     $('input:checkbox[name="clipc_group[]"][value="' + x + '"]').prop('checked', true);
                 }
                 //get the new clip code and update the input box:

                 var checkedValues = $('input:checkbox[name="clipc_group[]"]:checked').map(function() {
                     // return the value of each checked checkbox
                     return this.value;
                 }).get();

                 clips = checkedValues.join("");
                 $('input[id="id_clipc"]').val(clips);

             }  //valid is true/false
         }

     });


     $('input:checkbox[name="clipc_group[]"]').on('click change', function(e) {

         // this function builds clip code from the check boxes and populate clipc
         // input element.  clips are added squentially unless 0 is checked, in which
         // the inputs are cleared/reset.

         var checkedValues = $('input:checkbox[name="clipc_group[]"]:checked').map(function() {
             // return the value of each checked checkbox
             return this.value;
         }).get();

         //remove any residual errors from manual input:
         $( "#clipc_error" ).hide();
         $( "#clipc_input" ).removeClass("has-error");


         var just_clicked = $(this).attr('value');
         var clip0 = $('input:checkbox[name="clipc_group[]"][value="0"]').is(':checked');

         if (clip0===true && just_clicked==='0'){
             //unclipped is not checked and was just clicked
             //set clip0 input to 0
             $('input[id="id_clipc"]').val("0");
             $('input:checkbox[name="clipc_group[]"][value!="0"]').prop('checked',false)
                 $('input:checkbox[name="clipc_group[]"][value="0"]').prop('checked', true)

         } else if (clip0===false && just_clicked!=='0') {
             //unclipped is not checked and another box was just clicked
             //set clip0 input to None
             clips = checkedValues.join("");
             $('input[id="id_clipc"]').val(clips);

         } else if (clip0===false && just_clicked==='0'){
             //unclipped is already checked and was just clicked
             //$('input[id="id_clipc"]').val("EMPTY");
             var placeholder = $('input[id="id_clipc"]').attr('placeholder');
             $('input[id="id_clipc"]').val(placeholder);

         } else if (clip0===true && just_clicked!=='0') {
             //unclipped is already checked and another box was just clicked
             $('input:checkbox[name="clipc_group[]"][value="0"]').prop('checked',false);
             $('input[id="id_clipc"]').val(just_clicked);
         }


     });


     $('#myTabs a').click(function (e) {
         e.preventDefault()
             $(this).tab('show')
     });


     // ROUND WEIGHT CONTROLS
     $('input[name="rwt_units"]').click(function (e) {
         $('input[id="id_rwt_lbs"]').toggle();
         $('input[id="id_rwt"]').toggle();
     });
     $('input[id="id_rwt"]').change (rwt_g2lbs)
     $('input[id="id_rwt_lbs"]').change (rwt_lbs2g)


     // FORK LENGTH CONTROLS
     $('input[name="flen_units"]').click(function (e) {
         $('input[id="id_flen_inches"]').toggle();
         $('input[id="id_flen"]').toggle();
     });
     $('input[id="id_flen"]').change (flen_mm2inches)
     $('input[id="id_flen_inches"]').change (flen_inches2mm)

     // TOTAL LENGTH CONTROLS

     $('input[name="tlen_units"]').click(function (e) {
         $('input[id="id_tlen_inches"]').toggle();
         $('input[id="id_tlen"]').toggle();
     });
     $('input[id="id_tlen"]').change (tlen_mm2inches)
     $('input[id="id_tlen_inches"]').change (tlen_inches2mm)


     // GIRTH LENGTH CONTROLS

     $('input[name="girth_units"]').click(function (e) {
         $('input[id="id_girth_inches"]').toggle();
         $('input[id="id_girth"]').toggle();
     });

     $('input[id="id_girth"]').change (girth_mm2inches)
     $('input[id="id_girth_inches"]').change (girth_inches2mm)


     $('input:radio[name="latlon_flag"]').on('click change', function(e) {
         var spatial_flag = $('input:radio:checked[name="latlon_flag"]').val();
         // if spatial flag is 0, clear out all of the spatial information and delete our markers

         if (spatial_flag === '2'){
             $('#derived_comment').show();

         } else {
             $('#derived_comment').hide();
         }

         if (spatial_flag === '0'){

             $('input[id="id_dd_lat"]').val('');
             $('input[id="ddm_lat_deg"]').val('');
             $('input[id="ddm_lat_min"]').val('');

             $('input[id="dms_lat_deg"]').val('');
             $('input[id="dms_lat_min"]').val('');
             $('input[id="dms_lat_sec"]').val('');


             $('input[id="id_dd_lon"]').val('');
             $('input[id="ddm_lon_deg"]').val('');
             $('input[id="ddm_lon_min"]').val('');

             $('input[id="dms_lon_deg"]').val('');
             $('input[id="dms_lon_min"]').val('');
             $('input[id="dms_lon_sec"]').val('');


             if (my_markers.length && typeof my_markers[0] !== 'undefined'){
                 my_map.removeLayer(my_markers[0]);
                 delete my_markers[0];
             }

             if (popup_markers.length && typeof popup_markers[0] !== 'undefined'){
                 popup_map.removeLayer(popup_markers[0]);
                 delete popup_markers[0];
             }


             refresh_map();

         }

     });

 });

 $(function () {
     $('[data-toggle="popover"]').popover()
 });

 $(function() {
     $( ".datepicker" ).datepicker({ dateFormat: 'yy-mm-dd' });
 });

</script>


{% endblock %}
